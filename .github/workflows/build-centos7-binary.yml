name: "Build CentOS 7 Static Binary"

on:
  push:
    branches: [master]
    tags:
      - 'v*'
  pull_request:
    branches: [master]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      debug_enabled:
        description: 'Enable debug output'
        required: false
        default: 'false'

jobs:
  build-centos7-static:
    name: Build Static Binary for CentOS 7 (x86_64)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc \
          g++ \
          make \
          cmake \
          git \
          wget \
          curl \
          libssl-dev \
          libsasl2-dev \
          zlib1g-dev \
          libcurl4-openssl-dev \
          python3 \
          binutils \
          libsasl2-modules \
          libsasl2-modules-gssapi-mit
    
    - name: Build static kcat binary
      run: |
        echo "=========================================="
        echo "Building FULLY static kcat binary for CentOS 7"
        echo "=========================================="
        
        # Install static libraries
        sudo apt-get install -y \
          libssl-dev \
          libsasl2-dev \
          zlib1g-dev \
          libcurl4-openssl-dev
        
        # Run bootstrap to build librdkafka and other dependencies
        ./bootstrap.sh
        
        echo ""
        echo "Rebuilding with complete static linking..."
        echo ""
        
        # Set up paths
        export DEST="$PWD/tmp-bootstrap/usr"
        
        # Clean and reconfigure
        make clean || true
        ./configure --clean
        
        # Configure with all static libraries
        ./configure --enable-static --enable-json --enable-avro \
          CPPFLAGS="-I$DEST/include" \
          LDFLAGS="-L$DEST/lib -static" \
          LIBS="-lrdkafka -lyajl_s -lavro -ljansson -lserdes -lcurl -lssl -lcrypto -lsasl2 -lz -lpthread -lrt -ldl -lresolv"
        
        # Build
        make
        
        echo ""
        echo "Build completed! Verifying binary..."
        echo ""
        
        # Verify the binary
        ls -lh kcat
        file kcat
        
        # Check if it's static
        echo ""
        echo "Checking if binary is static:"
        if ldd kcat 2>&1 | grep -q "not a dynamic executable"; then
          echo "âœ… SUCCESS: Fully static binary!"
        else
          echo "âš ï¸  WARNING: Binary has dynamic dependencies:"
          ldd kcat
          echo ""
          echo "This binary may not work on CentOS 7 without installing dependencies."
        fi
        
        # Check binary size
        SIZE=$(stat -c%s kcat)
        echo ""
        echo "Binary size: $SIZE bytes ($(($SIZE / 1024 / 1024)) MB)"
        
        # Test basic functionality
        echo ""
        echo "Testing kcat functionality:"
        ./kcat -V || echo "Note: -V flag may not work, trying -h"
        ./kcat -h 2>&1 | head -20 || echo "Binary test completed"
    
    - name: Package binary with metadata
      run: |
        echo "Packaging binary for distribution..."
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p release
        
        # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
        cp kcat release/
        strip release/kcat  # ç§»é™¤è°ƒè¯•ç¬¦å·ä»¥å‡å°ä½“ç§¯
        
        # èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
        VERSION=$(./kcat -V 2>&1 | head -1 | awk '{print $2}')
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        cat > release/VERSION.txt << EOF
        kcat Binary for CentOS 7 (Static Build)
        ========================================
        Version: ${VERSION}
        Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Git Commit: ${GITHUB_SHA:0:8}
        Git Branch: ${GITHUB_REF#refs/heads/}
        Architecture: x86_64
        
        This is a statically linked binary that can run on CentOS 7
        and compatible systems (RHEL 7, Oracle Linux 7, etc.) without 
        any external dependencies.
        
        System Requirements:
        - CentOS 7 / RHEL 7 or compatible (x86_64)
        - Linux kernel 3.10 or later
        - No additional libraries required
        
        Quick Start:
          tar -xzf kcat-centos7-static-*.tar.gz
          cd release
          chmod +x kcat
          ./kcat -V
        
        Installation:
          sudo ./install.sh
        
        For full documentation, visit:
        https://github.com/edenhill/kcat
        EOF
        
        # å¤åˆ¶æ–‡æ¡£
        cp README.md release/
        cp LICENSE release/
        [ -f kcat.1 ] && cp kcat.1 release/ || true
        
        # åˆ›å»ºå®‰è£…è„šæœ¬
        cat > release/install.sh << 'INSTALLEOF'
        #!/bin/bash
        set -e
        
        INSTALL_DIR="/usr/local/bin"
        BINARY_NAME="kcat"
        
        echo "=========================================="
        echo "kcat Installation Script"
        echo "=========================================="
        echo ""
        
        # æ£€æŸ¥æ˜¯å¦ä¸º root
        if [ "$EUID" -ne 0 ]; then
          echo "âŒ Error: This script must be run as root or with sudo"
          echo "   Usage: sudo ./install.sh"
          exit 1
        fi
        
        # æ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$BINARY_NAME" ]; then
          echo "âŒ Error: $BINARY_NAME binary not found in current directory"
          exit 1
        fi
        
        # å¤‡ä»½æ—§ç‰ˆæœ¬ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
        if [ -f "$INSTALL_DIR/$BINARY_NAME" ]; then
          echo "ðŸ“¦ Backing up existing kcat to ${INSTALL_DIR}/${BINARY_NAME}.backup"
          cp "$INSTALL_DIR/$BINARY_NAME" "$INSTALL_DIR/${BINARY_NAME}.backup"
        fi
        
        # å®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶
        echo "ðŸ“¥ Installing kcat to $INSTALL_DIR..."
        cp "$BINARY_NAME" "$INSTALL_DIR/"
        chmod +x "$INSTALL_DIR/$BINARY_NAME"
        
        # éªŒè¯å®‰è£…
        if [ -x "$INSTALL_DIR/$BINARY_NAME" ]; then
          echo ""
          echo "âœ… Installation successful!"
          echo ""
          echo "Installed version:"
          "$INSTALL_DIR/$BINARY_NAME" -V
          echo ""
          echo "You can now run 'kcat' from anywhere."
          echo "Try: kcat -h"
        else
          echo "âŒ Installation failed"
          exit 1
        fi
        INSTALLEOF
        
        chmod +x release/install.sh
        
        # åˆ›å»ºå¸è½½è„šæœ¬
        cat > release/uninstall.sh << 'UNINSTALLEOF'
        #!/bin/bash
        set -e
        
        INSTALL_DIR="/usr/local/bin"
        BINARY_NAME="kcat"
        
        if [ "$EUID" -ne 0 ]; then
          echo "âŒ Error: This script must be run as root or with sudo"
          exit 1
        fi
        
        if [ -f "$INSTALL_DIR/$BINARY_NAME" ]; then
          echo "ðŸ—‘ï¸  Removing kcat from $INSTALL_DIR..."
          rm -f "$INSTALL_DIR/$BINARY_NAME"
          echo "âœ… kcat has been uninstalled"
        else
          echo "â„¹ï¸  kcat is not installed in $INSTALL_DIR"
        fi
        UNINSTALLEOF
        
        chmod +x release/uninstall.sh
        
        # åˆ›å»º README
        cat > release/README_INSTALL.txt << 'READMEEOF'
        kcat - CentOS 7 Static Binary
        ==============================
        
        æ­¤åŽ‹ç¼©åŒ…åŒ…å«å¯åœ¨ CentOS 7 ç¦»çº¿çŽ¯å¢ƒä½¿ç”¨çš„ kcat é™æ€ç¼–è¯‘ç‰ˆæœ¬ã€‚
        
        æ–‡ä»¶è¯´æ˜Žï¼š
        ---------
        kcat            - ä¸»ç¨‹åºäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆé™æ€é“¾æŽ¥ï¼‰
        install.sh      - å®‰è£…è„šæœ¬ï¼ˆå®‰è£…åˆ° /usr/local/binï¼‰
        uninstall.sh    - å¸è½½è„šæœ¬
        VERSION.txt     - ç‰ˆæœ¬å’Œæž„å»ºä¿¡æ¯
        README.md       - å®Œæ•´æ–‡æ¡£
        LICENSE         - è®¸å¯è¯
        
        ä½¿ç”¨æ–¹æ³•ï¼š
        ---------
        
        æ–¹å¼ 1: ç›´æŽ¥è¿è¡Œï¼ˆæ— éœ€å®‰è£…ï¼‰
        $ chmod +x kcat
        $ ./kcat -V
        $ ./kcat -b broker:9092 -L
        
        æ–¹å¼ 2: å®‰è£…åˆ°ç³»ç»Ÿ
        $ sudo ./install.sh
        $ kcat -V
        
        å¸è½½ï¼š
        $ sudo ./uninstall.sh
        
        å¸¸ç”¨å‘½ä»¤ç¤ºä¾‹ï¼š
        -------------
        # æŸ¥çœ‹ç‰ˆæœ¬
        kcat -V
        
        # åˆ—å‡ºé›†ç¾¤å…ƒæ•°æ®
        kcat -b broker:9092 -L
        
        # æ¶ˆè´¹æ¶ˆæ¯
        kcat -b broker:9092 -t my-topic -C
        
        # ç”Ÿäº§æ¶ˆæ¯
        echo "hello world" | kcat -b broker:9092 -t my-topic -P
        
        # æŸ¥çœ‹å¸®åŠ©
        kcat -h
        
        æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ README.md æˆ–è®¿é—®ï¼š
        https://github.com/edenhill/kcat
        READMEEOF
        
        # åˆ›å»ºåŽ‹ç¼©åŒ…
        TARBALL_NAME="kcat-centos7-static-${GITHUB_SHA:0:8}.tar.gz"
        tar -czf "$TARBALL_NAME" -C release .
        
        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        echo ""
        echo "=========================================="
        echo "Package created successfully!"
        echo "=========================================="
        ls -lh "$TARBALL_NAME"
        echo ""
        echo "Contents:"
        tar -tzf "$TARBALL_NAME"
    
    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: kcat-centos7-static-binary
        path: |
          kcat-centos7-static-*.tar.gz
          release/kcat
        retention-days: 90
        compression-level: 6
    
    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: kcat-centos7-static-*.tar.gz
        body: |
          ## CentOS 7 Static Binary Release
          
          This release includes a statically linked kcat binary for CentOS 7 and compatible systems.
          
          ### Download and Install
          ```bash
          # ä¸‹è½½å¹¶è§£åŽ‹
          tar -xzf kcat-centos7-static-*.tar.gz
          cd release
          
          # æ–¹å¼1: ç›´æŽ¥ä½¿ç”¨
          chmod +x kcat
          ./kcat -V
          
          # æ–¹å¼2: å®‰è£…åˆ°ç³»ç»Ÿ
          sudo ./install.sh
          ```
          
          ### Features
          - âœ… é™æ€é“¾æŽ¥ï¼Œæ— éœ€å®‰è£…ä¾èµ–
          - âœ… æ”¯æŒ CentOS 7 åŠå…¼å®¹ç³»ç»Ÿ
          - âœ… åŒ…å«å®Œæ•´åŠŸèƒ½ï¼ˆJSON, Avro, Transactionsï¼‰
          - âœ… å¯åœ¨ç¦»çº¿çŽ¯å¢ƒä½¿ç”¨
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
