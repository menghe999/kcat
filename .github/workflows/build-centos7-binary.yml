name: "Build CentOS 7 Static Binary"

on:
  push:
    branches: [master]
    tags:
      - 'v*'
  pull_request:
    branches: [master]
  workflow_dispatch:  # 允许手动触发
    inputs:
      debug_enabled:
        description: 'Enable debug output'
        required: false
        default: 'false'

jobs:
  build-centos7-static:
    name: Build Static Binary for CentOS 7 (x86_64)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc \
          g++ \
          make \
          cmake \
          git \
          wget \
          curl \
          libssl-dev \
          libsasl2-dev \
          zlib1g-dev \
          libcurl4-openssl-dev \
          python3 \
          binutils \
          libsasl2-modules \
          libsasl2-modules-gssapi-mit
    
    - name: Build static kcat binary
      run: |
        echo "=========================================="
        echo "Building kcat with bundled dependencies for CentOS 7"
        echo "=========================================="
        
        # Run bootstrap to build librdkafka and other dependencies
        ./bootstrap.sh
        
        echo ""
        echo "Build completed! Verifying binary..."
        echo ""
        
        # Verify the binary
        ls -lh kcat
        file kcat
        
        # Check dynamic dependencies
        echo ""
        echo "Checking dynamic dependencies:"
        ldd kcat
        
        # Check binary size
        SIZE=$(stat -c%s kcat)
        echo ""
        echo "Binary size: $SIZE bytes ($(($SIZE / 1024 / 1024)) MB)"
        
        # Test basic functionality
        echo ""
        echo "Testing kcat functionality:"
        ./kcat -V
        ./kcat -h | head -20
    
    - name: Package binary with metadata
      run: |
        echo "=========================================="
        echo "Creating portable package with bundled dependencies"
        echo "=========================================="
        
        # Create release directory structure
        mkdir -p release/bin
        mkdir -p release/lib
        
        # Copy the kcat binary
        cp kcat release/bin/
        strip release/bin/kcat  # Remove debug symbols
        
        # Copy all required shared libraries
        echo ""
        echo "Collecting required shared libraries..."
        
        # Get list of dependencies and copy them
        ldd kcat | grep "=> /" | awk '{print $3}' | while read lib; do
          # Skip system libraries that should be available on CentOS 7
          case "$lib" in
            */libc.so.* | */libm.so.* | */libpthread.so.* | */libdl.so.* | */librt.so.* | */libresolv.so.*)
              echo "  Skipping system library: $lib"
              ;;
            *)
              echo "  Copying: $lib"
              cp -L "$lib" release/lib/ || true
              ;;
          esac
        done
        
        # Also copy libraries from our bootstrap build
        echo ""
        echo "Copying bootstrap-built libraries..."
        if [ -d tmp-bootstrap/usr/lib ]; then
          cp -v tmp-bootstrap/usr/lib/*.so* release/lib/ 2>/dev/null || true
        fi
        
        # List what we've collected
        echo ""
        echo "Bundled libraries:"
        ls -lh release/lib/
        
        # Create wrapper script
        cat > release/kcat << 'EOF'
        #!/bin/bash
        # kcat wrapper script with bundled dependencies
        
        # Get the directory where this script is located
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        
        # Set LD_LIBRARY_PATH to include our bundled libraries
        export LD_LIBRARY_PATH="${SCRIPT_DIR}/lib:${LD_LIBRARY_PATH}"
        
        # Execute the actual kcat binary with all arguments
        exec "${SCRIPT_DIR}/bin/kcat" "$@"
        EOF
        
        chmod +x release/kcat
        
        # Get version information
        VERSION=$(./kcat -V 2>&1 | head -1 | awk '{print $2}')
        
        # Create version info file
        cat > release/VERSION.txt << 'EOF'
        kcat Portable Binary for CentOS 7
        ==================================
        Version: ${VERSION}
        Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Git Commit: ${GITHUB_SHA:0:8}
        Git Branch: ${GITHUB_REF#refs/heads/}
        Architecture: x86_64
        Package Type: Portable (with bundled dependencies)
        
        This package includes kcat and all required shared libraries,
        making it portable across CentOS 7 and compatible systems.
        
        System Requirements:
        - CentOS 7 / RHEL 7 or compatible (x86_64)
        - Linux kernel 3.10 or later
        - Basic system libraries (glibc, libm, libpthread, etc.)
        
        Quick Start:
          tar -xzf kcat-centos7-portable-*.tar.gz
          cd kcat-centos7-portable
          ./kcat -V
        
        Installation (optional):
          sudo ./install.sh
        
        The wrapper script automatically sets LD_LIBRARY_PATH to use
        the bundled libraries, so no system-wide installation is required.
        
        For full documentation, visit:
        https://github.com/edenhill/kcat
        EOF
        
        # Copy documentation
        cp README.md release/
        cp LICENSE release/
        [ -f kcat.1 ] && cp kcat.1 release/ || true
        
        # Create installation script
        cat > release/install.sh << 'EOF'
        #!/bin/bash
        set -e
        
        INSTALL_DIR="/usr/local"
        PACKAGE_NAME="kcat"
        
        echo "=========================================="
        echo "kcat Portable Installation Script"
        echo "=========================================="
        echo ""
        
        # Check if running as root
        if [ "$EUID" -ne 0 ]; then
          echo "Error: This script must be run as root or with sudo"
          echo "   Usage: sudo ./install.sh"
          exit 1
        fi
        
        # Check if files exist
        if [ ! -f "kcat" ] || [ ! -f "bin/kcat" ]; then
          echo "Error: kcat files not found in current directory"
          exit 1
        fi
        
        # Backup old version if exists
        if [ -d "$INSTALL_DIR/$PACKAGE_NAME" ]; then
          echo "Backing up existing installation to ${INSTALL_DIR}/${PACKAGE_NAME}.backup"
          rm -rf "$INSTALL_DIR/${PACKAGE_NAME}.backup"
          mv "$INSTALL_DIR/$PACKAGE_NAME" "$INSTALL_DIR/${PACKAGE_NAME}.backup"
        fi
        
        # Create installation directory
        echo "Installing kcat to $INSTALL_DIR/$PACKAGE_NAME..."
        mkdir -p "$INSTALL_DIR/$PACKAGE_NAME"
        
        # Copy all files
        cp -r bin lib kcat "$INSTALL_DIR/$PACKAGE_NAME/"
        [ -f VERSION.txt ] && cp VERSION.txt "$INSTALL_DIR/$PACKAGE_NAME/" || true
        [ -f README.md ] && cp README.md "$INSTALL_DIR/$PACKAGE_NAME/" || true
        [ -f LICENSE ] && cp LICENSE "$INSTALL_DIR/$PACKAGE_NAME/" || true
        
        # Create symlink in /usr/local/bin
        echo "Creating symlink in /usr/local/bin..."
        ln -sf "$INSTALL_DIR/$PACKAGE_NAME/kcat" /usr/local/bin/kcat
        
        # Verify installation
        if [ -x "/usr/local/bin/kcat" ]; then
          echo ""
          echo "Installation successful!"
          echo ""
          echo "Installed version:"
          /usr/local/bin/kcat -V
          echo ""
          echo "You can now run 'kcat' from anywhere."
          echo "Try: kcat -h"
          echo ""
          echo "Installation location: $INSTALL_DIR/$PACKAGE_NAME"
        else
          echo "Installation failed"
          exit 1
        fi
        EOF
        
        chmod +x release/install.sh
        
        # Create uninstall script
        cat > release/uninstall.sh << 'EOF'
        #!/bin/bash
        set -e
        
        INSTALL_DIR="/usr/local"
        PACKAGE_NAME="kcat"
        
        if [ "$EUID" -ne 0 ]; then
          echo "Error: This script must be run as root or with sudo"
          exit 1
        fi
        
        echo "Uninstalling kcat..."
        
        # Remove symlink
        if [ -L "/usr/local/bin/kcat" ]; then
          rm -f /usr/local/bin/kcat
          echo "  Removed symlink: /usr/local/bin/kcat"
        fi
        
        # Remove installation directory
        if [ -d "$INSTALL_DIR/$PACKAGE_NAME" ]; then
          rm -rf "$INSTALL_DIR/$PACKAGE_NAME"
          echo "  Removed directory: $INSTALL_DIR/$PACKAGE_NAME"
        fi
        
        echo "kcat has been uninstalled"
        EOF
        
        chmod +x release/uninstall.sh
        
        # Create README
        cat > release/README_INSTALL.txt << 'EOF'
        kcat - CentOS 7 Portable Package
        =================================
        
        This package contains kcat and all required dependencies for CentOS 7.
        
        Files:
        ---------
        kcat            - Wrapper script (auto-sets library path)
        bin/kcat        - Actual binary file
        lib/            - All required shared libraries
        install.sh      - Installation script (installs to /usr/local)
        uninstall.sh    - Uninstallation script
        VERSION.txt     - Version and build information
        README.md       - Full documentation
        LICENSE         - License
        
        Usage:
        ---------
        
        Method 1: Direct run (recommended, no installation needed)
        $ ./kcat -V
        $ ./kcat -b broker:9092 -L
        
        Method 2: Install to system
        $ sudo ./install.sh
        $ kcat -V
        
        Uninstall:
        $ sudo ./uninstall.sh
        
        How it works:
        ---------
        The kcat wrapper script automatically sets LD_LIBRARY_PATH to use
        the bundled libraries instead of system libraries, so no system
        dependencies need to be installed.
        
        Common commands:
        -------------
        # Check version
        ./kcat -V
        
        # List cluster metadata
        ./kcat -b broker:9092 -L
        
        # Consume messages
        ./kcat -b broker:9092 -t my-topic -C
        
        # Produce messages
        echo "hello world" | ./kcat -b broker:9092 -t my-topic -P
        
        # Show help
        ./kcat -h
        
        Troubleshooting:
        ---------
        If you encounter "error while loading shared libraries":
        1. Make sure to use the wrapper script ./kcat not bin/kcat
        2. Check that lib/ directory contains all library files
        3. Try manually setting: export LD_LIBRARY_PATH=$(pwd)/lib:$LD_LIBRARY_PATH
        
        For more information see README.md or visit:
        https://github.com/edenhill/kcat
        EOF
        
        # Create the tarball
        cd release
        TARBALL_NAME="kcat-centos7-portable-${GITHUB_SHA:0:8}.tar.gz"
        tar -czf "../$TARBALL_NAME" .
        cd ..
        
        # Display package info
        echo ""
        echo "=========================================="
        echo "Portable package created successfully!"
        echo "=========================================="
        ls -lh "$TARBALL_NAME"
        echo ""
        echo "Package contents:"
        tar -tzf "$TARBALL_NAME" | head -20
        echo ""
        echo "Total files: $(tar -tzf "$TARBALL_NAME" | wc -l)"
        
        # Test the wrapper script
        echo ""
        echo "Testing wrapper script..."
        cd release
        ./kcat -V || echo "Wrapper test completed"
        cd ..
    
    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: kcat-centos7-portable-package
        path: |
          kcat-centos7-portable-*.tar.gz
        retention-days: 90
        compression-level: 6
    
    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: kcat-centos7-portable-*.tar.gz
        body: |
          ## CentOS 7 Portable Binary Release
          
          This release includes a portable kcat package with all required dependencies bundled.
          
          ### Download and Install
          ```bash
          # 下载并解压
          tar -xzf kcat-centos7-portable-*.tar.gz
          cd kcat-centos7-portable
          
          # 方式1: 直接使用（推荐）
          ./kcat -V
          ./kcat -b broker:9092 -L
          
          # 方式2: 安装到系统
          sudo ./install.sh
          ```
          
          ### Features
          - ✅ 包含所有依赖库，无需额外安装
          - ✅ 支持 CentOS 7 及兼容系统
          - ✅ 包含完整功能（JSON, Avro, Transactions）
          - ✅ 可在离线环境使用
          - ✅ 使用包装脚本自动设置库路径
          
          ### Package Contents
          - `kcat` - Wrapper script with automatic library path setup
          - `bin/kcat` - The actual kcat binary
          - `lib/` - All required shared libraries
          - `install.sh` - System installation script
          - `uninstall.sh` - Uninstallation script
          
          ### How It Works
          The wrapper script automatically sets `LD_LIBRARY_PATH` to use the bundled libraries,
          making the package fully portable without requiring system-wide library installation.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
