name: "Build CentOS 7 Static Binary"

on:
  push:
    branches: [master]
    tags:
      - 'v*'
  pull_request:
    branches: [master]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      debug_enabled:
        description: 'Enable debug output'
        required: false
        default: 'false'

jobs:
  build-centos7-static:
    name: Build Static Binary for CentOS 7 (x86_64)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc \
          g++ \
          make \
          cmake \
          git \
          wget \
          curl \
          libssl-dev \
          libsasl2-dev \
          zlib1g-dev \
          libcurl4-openssl-dev \
          python3 \
          binutils \
          libsasl2-modules \
          libsasl2-modules-gssapi-mit
    
    - name: Build static kcat binary
      run: |
        echo "=========================================="
        echo "Building kcat with bundled dependencies for CentOS 7"
        echo "=========================================="
        
        # Run bootstrap to build librdkafka and other dependencies
        ./bootstrap.sh
        
        echo ""
        echo "Build completed! Verifying binary..."
        echo ""
        
        # Verify the binary
        ls -lh kcat
        file kcat
        
        # Check dynamic dependencies
        echo ""
        echo "Checking dynamic dependencies:"
        ldd kcat
        
        # Check binary size
        SIZE=$(stat -c%s kcat)
        echo ""
        echo "Binary size: $SIZE bytes ($(($SIZE / 1024 / 1024)) MB)"
        
        # Test basic functionality
        echo ""
        echo "Testing kcat functionality:"
        ./kcat -V
        ./kcat -h | head -20
    
    - name: Package binary with metadata
      run: |
        echo "=========================================="
        echo "Creating portable package with bundled dependencies"
        echo "=========================================="
        
        # Create release directory structure
        mkdir -p release/bin
        mkdir -p release/lib
        
        # Copy the kcat binary
        cp kcat release/bin/
        strip release/bin/kcat  # Remove debug symbols
        
        # Copy all required shared libraries
        echo ""
        echo "Collecting required shared libraries..."
        
        # Get list of dependencies and copy them
        ldd kcat | grep "=> /" | awk '{print $3}' | while read lib; do
          # Skip system libraries that should be available on CentOS 7
          case "$lib" in
            */libc.so.* | */libm.so.* | */libpthread.so.* | */libdl.so.* | */librt.so.* | */libresolv.so.*)
              echo "  Skipping system library: $lib"
              ;;
            *)
              echo "  Copying: $lib"
              cp -L "$lib" release/lib/ || true
              ;;
          esac
        done
        
        # Also copy libraries from our bootstrap build
        echo ""
        echo "Copying bootstrap-built libraries..."
        if [ -d tmp-bootstrap/usr/lib ]; then
          cp -v tmp-bootstrap/usr/lib/*.so* release/lib/ 2>/dev/null || true
        fi
        
        # List what we've collected
        echo ""
        echo "Bundled libraries:"
        ls -lh release/lib/
        
        # Create wrapper script
        cat > release/kcat << 'WRAPPER_EOF'
#!/bin/bash
# kcat wrapper script with bundled dependencies

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Set LD_LIBRARY_PATH to include our bundled libraries
export LD_LIBRARY_PATH="${SCRIPT_DIR}/lib:${LD_LIBRARY_PATH}"

# Execute the actual kcat binary with all arguments
exec "${SCRIPT_DIR}/bin/kcat" "$@"
WRAPPER_EOF
        
        chmod +x release/kcat
        
        # Get version information
        VERSION=$(./kcat -V 2>&1 | head -1 | awk '{print $2}')
        
        # Create version info file
        cat > release/VERSION.txt << EOF
kcat Portable Binary for CentOS 7
==================================
Version: ${VERSION}
Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
Git Commit: ${GITHUB_SHA:0:8}
Git Branch: ${GITHUB_REF#refs/heads/}
Architecture: x86_64
Package Type: Portable (with bundled dependencies)

This package includes kcat and all required shared libraries,
making it portable across CentOS 7 and compatible systems.

System Requirements:
- CentOS 7 / RHEL 7 or compatible (x86_64)
- Linux kernel 3.10 or later
- Basic system libraries (glibc, libm, libpthread, etc.)

Quick Start:
  tar -xzf kcat-centos7-portable-*.tar.gz
  cd kcat-centos7-portable
  ./kcat -V

Installation (optional):
  sudo ./install.sh

The wrapper script automatically sets LD_LIBRARY_PATH to use
the bundled libraries, so no system-wide installation is required.

For full documentation, visit:
https://github.com/edenhill/kcat
EOF
        
        # Copy documentation
        cp README.md release/
        cp LICENSE release/
        [ -f kcat.1 ] && cp kcat.1 release/ || true
        
        # Create installation script
        cat > release/install.sh << 'INSTALLEOF'
#!/bin/bash
set -e

INSTALL_DIR="/usr/local"
PACKAGE_NAME="kcat"

echo "=========================================="
echo "kcat Portable Installation Script"
echo "=========================================="
echo ""

# Check if running as root
if [ "$EUID" -ne 0 ]; then
  echo "âŒ Error: This script must be run as root or with sudo"
  echo "   Usage: sudo ./install.sh"
  exit 1
fi

# Check if files exist
if [ ! -f "kcat" ] || [ ! -f "bin/kcat" ]; then
  echo "âŒ Error: kcat files not found in current directory"
  exit 1
fi

# Backup old version if exists
if [ -d "$INSTALL_DIR/$PACKAGE_NAME" ]; then
  echo "ðŸ“¦ Backing up existing installation to ${INSTALL_DIR}/${PACKAGE_NAME}.backup"
  rm -rf "$INSTALL_DIR/${PACKAGE_NAME}.backup"
  mv "$INSTALL_DIR/$PACKAGE_NAME" "$INSTALL_DIR/${PACKAGE_NAME}.backup"
fi

# Create installation directory
echo "ðŸ“¥ Installing kcat to $INSTALL_DIR/$PACKAGE_NAME..."
mkdir -p "$INSTALL_DIR/$PACKAGE_NAME"

# Copy all files
cp -r bin lib kcat "$INSTALL_DIR/$PACKAGE_NAME/"
[ -f VERSION.txt ] && cp VERSION.txt "$INSTALL_DIR/$PACKAGE_NAME/" || true
[ -f README.md ] && cp README.md "$INSTALL_DIR/$PACKAGE_NAME/" || true
[ -f LICENSE ] && cp LICENSE "$INSTALL_DIR/$PACKAGE_NAME/" || true

# Create symlink in /usr/local/bin
echo "ðŸ”— Creating symlink in /usr/local/bin..."
ln -sf "$INSTALL_DIR/$PACKAGE_NAME/kcat" /usr/local/bin/kcat

# Verify installation
if [ -x "/usr/local/bin/kcat" ]; then
  echo ""
  echo "âœ… Installation successful!"
  echo ""
  echo "Installed version:"
  /usr/local/bin/kcat -V
  echo ""
  echo "You can now run 'kcat' from anywhere."
  echo "Try: kcat -h"
  echo ""
  echo "Installation location: $INSTALL_DIR/$PACKAGE_NAME"
else
  echo "âŒ Installation failed"
  exit 1
fi
INSTALLEOF
        
        chmod +x release/install.sh
        
        # Create uninstall script
        cat > release/uninstall.sh << 'UNINSTALLEOF'
#!/bin/bash
set -e

INSTALL_DIR="/usr/local"
PACKAGE_NAME="kcat"

if [ "$EUID" -ne 0 ]; then
  echo "âŒ Error: This script must be run as root or with sudo"
  exit 1
fi

echo "ðŸ—‘ï¸  Uninstalling kcat..."

# Remove symlink
if [ -L "/usr/local/bin/kcat" ]; then
  rm -f /usr/local/bin/kcat
  echo "  Removed symlink: /usr/local/bin/kcat"
fi

# Remove installation directory
if [ -d "$INSTALL_DIR/$PACKAGE_NAME" ]; then
  rm -rf "$INSTALL_DIR/$PACKAGE_NAME"
  echo "  Removed directory: $INSTALL_DIR/$PACKAGE_NAME"
fi

echo "âœ… kcat has been uninstalled"
UNINSTALLEOF
        
        chmod +x release/uninstall.sh
        
        # Create README
        cat > release/README_INSTALL.txt << 'READMEEOF'
kcat - CentOS 7 Portable Package
=================================

æ­¤åŽ‹ç¼©åŒ…åŒ…å« kcat åŠå…¶æ‰€æœ‰ä¾èµ–åº“ï¼Œå¯åœ¨ CentOS 7 ç¦»çº¿çŽ¯å¢ƒç›´æŽ¥ä½¿ç”¨ã€‚

æ–‡ä»¶è¯´æ˜Žï¼š
---------
kcat            - åŒ…è£…è„šæœ¬ï¼ˆè‡ªåŠ¨è®¾ç½®åº“è·¯å¾„ï¼‰
bin/kcat        - å®žé™…çš„äºŒè¿›åˆ¶æ–‡ä»¶
lib/            - æ‰€æœ‰ä¾èµ–çš„å…±äº«åº“
install.sh      - å®‰è£…è„šæœ¬ï¼ˆå®‰è£…åˆ° /usr/localï¼‰
uninstall.sh    - å¸è½½è„šæœ¬
VERSION.txt     - ç‰ˆæœ¬å’Œæž„å»ºä¿¡æ¯
README.md       - å®Œæ•´æ–‡æ¡£
LICENSE         - è®¸å¯è¯

ä½¿ç”¨æ–¹æ³•ï¼š
---------

æ–¹å¼ 1: ç›´æŽ¥è¿è¡Œï¼ˆæŽ¨èï¼Œæ— éœ€å®‰è£…ï¼‰
$ ./kcat -V
$ ./kcat -b broker:9092 -L

æ–¹å¼ 2: å®‰è£…åˆ°ç³»ç»Ÿ
$ sudo ./install.sh
$ kcat -V

å¸è½½ï¼š
$ sudo ./uninstall.sh

å·¥ä½œåŽŸç†ï¼š
---------
kcat åŒ…è£…è„šæœ¬ä¼šè‡ªåŠ¨è®¾ç½® LD_LIBRARY_PATH çŽ¯å¢ƒå˜é‡ï¼Œ
ä½¿ç¨‹åºä½¿ç”¨ lib/ ç›®å½•ä¸­çš„å…±äº«åº“ï¼Œè€Œä¸æ˜¯ç³»ç»Ÿåº“ã€‚
è¿™æ ·å°±ä¸éœ€è¦åœ¨ç³»ç»Ÿä¸­å®‰è£…ä»»ä½•ä¾èµ–ã€‚

å¸¸ç”¨å‘½ä»¤ç¤ºä¾‹ï¼š
-------------
# æŸ¥çœ‹ç‰ˆæœ¬
./kcat -V

# åˆ—å‡ºé›†ç¾¤å…ƒæ•°æ®
./kcat -b broker:9092 -L

# æ¶ˆè´¹æ¶ˆæ¯
./kcat -b broker:9092 -t my-topic -C

# ç”Ÿäº§æ¶ˆæ¯
echo "hello world" | ./kcat -b broker:9092 -t my-topic -P

# æŸ¥çœ‹å¸®åŠ©
./kcat -h

æ•…éšœæŽ’é™¤ï¼š
---------
å¦‚æžœé‡åˆ° "error while loading shared libraries" é”™è¯¯ï¼š
1. ç¡®ä¿ä½¿ç”¨åŒ…è£…è„šæœ¬ ./kcat è€Œä¸æ˜¯ bin/kcat
2. æ£€æŸ¥ lib/ ç›®å½•ä¸­çš„åº“æ–‡ä»¶æ˜¯å¦å®Œæ•´
3. å°è¯•æ‰‹åŠ¨è®¾ç½®ï¼šexport LD_LIBRARY_PATH=$(pwd)/lib:$LD_LIBRARY_PATH

æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ README.md æˆ–è®¿é—®ï¼š
https://github.com/edenhill/kcat
READMEEOF
        
        # Create the tarball
        cd release
        TARBALL_NAME="kcat-centos7-portable-${GITHUB_SHA:0:8}.tar.gz"
        tar -czf "../$TARBALL_NAME" .
        cd ..
        
        # Display package info
        echo ""
        echo "=========================================="
        echo "Portable package created successfully!"
        echo "=========================================="
        ls -lh "$TARBALL_NAME"
        echo ""
        echo "Package contents:"
        tar -tzf "$TARBALL_NAME" | head -20
        echo ""
        echo "Total files: $(tar -tzf "$TARBALL_NAME" | wc -l)"
        
        # Test the wrapper script
        echo ""
        echo "Testing wrapper script..."
        cd release
        ./kcat -V || echo "Wrapper test completed"
        cd ..
    
    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: kcat-centos7-portable-package
        path: |
          kcat-centos7-portable-*.tar.gz
        retention-days: 90
        compression-level: 6
    
    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: kcat-centos7-portable-*.tar.gz
        body: |
          ## CentOS 7 Portable Binary Release
          
          This release includes a portable kcat package with all required dependencies bundled.
          
          ### Download and Install
          ```bash
          # ä¸‹è½½å¹¶è§£åŽ‹
          tar -xzf kcat-centos7-portable-*.tar.gz
          cd kcat-centos7-portable
          
          # æ–¹å¼1: ç›´æŽ¥ä½¿ç”¨ï¼ˆæŽ¨èï¼‰
          ./kcat -V
          ./kcat -b broker:9092 -L
          
          # æ–¹å¼2: å®‰è£…åˆ°ç³»ç»Ÿ
          sudo ./install.sh
          ```
          
          ### Features
          - âœ… åŒ…å«æ‰€æœ‰ä¾èµ–åº“ï¼Œæ— éœ€é¢å¤–å®‰è£…
          - âœ… æ”¯æŒ CentOS 7 åŠå…¼å®¹ç³»ç»Ÿ
          - âœ… åŒ…å«å®Œæ•´åŠŸèƒ½ï¼ˆJSON, Avro, Transactionsï¼‰
          - âœ… å¯åœ¨ç¦»çº¿çŽ¯å¢ƒä½¿ç”¨
          - âœ… ä½¿ç”¨åŒ…è£…è„šæœ¬è‡ªåŠ¨è®¾ç½®åº“è·¯å¾„
          
          ### Package Contents
          - `kcat` - Wrapper script with automatic library path setup
          - `bin/kcat` - The actual kcat binary
          - `lib/` - All required shared libraries
          - `install.sh` - System installation script
          - `uninstall.sh` - Uninstallation script
          
          ### How It Works
          The wrapper script automatically sets `LD_LIBRARY_PATH` to use the bundled libraries,
          making the package fully portable without requiring system-wide library installation.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
