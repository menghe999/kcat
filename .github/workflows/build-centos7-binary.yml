name: "Build CentOS 7 Static Binary"

on:
  push:
    branches: [master]
    tags:
      - 'v*'
  pull_request:
    branches: [master]
  workflow_dispatch:  # 允许手动触发
    inputs:
      debug_enabled:
        description: 'Enable debug output'
        required: false
        default: 'false'

jobs:
  build-centos7-static:
    name: Build Static Binary for CentOS 7 (x86_64)
    runs-on: ubuntu-latest
    container:
      image: centos:7
    
    steps:
    - name: Install build dependencies in CentOS 7
      run: |
        # Update yum and install EPEL
        yum install -y epel-release
        yum update -y
        
        # Install build tools
        yum install -y \
          gcc \
          gcc-c++ \
          make \
          cmake3 \
          git \
          wget \
          curl \
          which \
          file \
          tar \
          gzip \
          bzip2 \
          python3 \
          openssl-devel \
          cyrus-sasl-devel \
          zlib-devel \
          libcurl-devel
        
        # Create cmake symlink
        ln -sf /usr/bin/cmake3 /usr/bin/cmake || true
    
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Build static kcat binary
      run: |
        echo "=========================================="
        echo "Building kcat with bundled dependencies for CentOS 7"
        echo "=========================================="
        
        # Run bootstrap to build librdkafka and other dependencies
        ./bootstrap.sh
        
        echo ""
        echo "Build completed! Verifying binary..."
        echo ""
        
        # Verify the binary
        ls -lh kcat
        file kcat
        
        # Check dynamic dependencies
        echo ""
        echo "Checking dynamic dependencies:"
        ldd kcat
        
        # Check binary size
        SIZE=$(stat -c%s kcat)
        echo ""
        echo "Binary size: $SIZE bytes ($(($SIZE / 1024 / 1024)) MB)"
        
        # Test basic functionality
        echo ""
        echo "Testing kcat functionality:"
        ./kcat -V
        ./kcat -h | head -20
    
    - name: Package binary with metadata
      run: |
        echo "=========================================="
        echo "Creating portable package"
        echo "=========================================="
        
        # Create release directory structure
        mkdir -p release/bin
        
        # Copy the kcat binary
        cp kcat release/bin/
        strip release/bin/kcat  # Remove debug symbols
        
        # Verify it's using CentOS 7 GLIBC
        echo ""
        echo "Verifying GLIBC compatibility:"
        ldd release/bin/kcat | grep GLIBC || true
        
        # Create wrapper script
        cat > release/kcat << 'EOF'
        #!/bin/bash
        # kcat wrapper script
        
        # Get the directory where this script is located
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        
        # Execute the actual kcat binary with all arguments
        exec "${SCRIPT_DIR}/bin/kcat" "$@"
        EOF
        
        chmod +x release/kcat
        
        # Get version information
        VERSION=$(./kcat -V 2>&1 | head -1 | awk '{print $2}')
        
        # Create version info file
        cat > release/VERSION.txt << 'EOF'
        kcat Binary for CentOS 7
        =========================
        Version: ${VERSION}
        Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Git Commit: ${GITHUB_SHA:0:8}
        Git Branch: ${GITHUB_REF#refs/heads/}
        Architecture: x86_64
        Build Environment: CentOS 7 (GLIBC 2.17)
        
        This binary is built on CentOS 7 and compatible with:
        - CentOS 7 / RHEL 7 or compatible (x86_64)
        - Linux kernel 3.10 or later
        - GLIBC 2.17 or later
        
        Quick Start:
          tar -xzf kcat-centos7-*.tar.gz
          cd kcat-centos7
          ./kcat -V
        
        Installation (optional):
          sudo ./install.sh
        
        For full documentation, visit:
        https://github.com/edenhill/kcat
        EOF
        
        # Copy documentation
        cp README.md release/
        cp LICENSE release/
        [ -f kcat.1 ] && cp kcat.1 release/ || true
        
        # Create installation script
        cat > release/install.sh << 'EOF'
        #!/bin/bash
        set -e
        
        INSTALL_DIR="/usr/local"
        PACKAGE_NAME="kcat"
        
        echo "=========================================="
        echo "kcat Portable Installation Script"
        echo "=========================================="
        echo ""
        
        # Check if running as root
        if [ "$EUID" -ne 0 ]; then
          echo "Error: This script must be run as root or with sudo"
          echo "   Usage: sudo ./install.sh"
          exit 1
        fi
        
        # Check if files exist
        if [ ! -f "kcat" ] || [ ! -f "bin/kcat" ]; then
          echo "Error: kcat files not found in current directory"
          exit 1
        fi
        
        # Backup old version if exists
        if [ -d "$INSTALL_DIR/$PACKAGE_NAME" ]; then
          echo "Backing up existing installation to ${INSTALL_DIR}/${PACKAGE_NAME}.backup"
          rm -rf "$INSTALL_DIR/${PACKAGE_NAME}.backup"
          mv "$INSTALL_DIR/$PACKAGE_NAME" "$INSTALL_DIR/${PACKAGE_NAME}.backup"
        fi
        
        # Create installation directory
        echo "Installing kcat to $INSTALL_DIR/$PACKAGE_NAME..."
        mkdir -p "$INSTALL_DIR/$PACKAGE_NAME"
        
        # Copy all files
        cp -r bin kcat "$INSTALL_DIR/$PACKAGE_NAME/"
        [ -f VERSION.txt ] && cp VERSION.txt "$INSTALL_DIR/$PACKAGE_NAME/" || true
        [ -f README.md ] && cp README.md "$INSTALL_DIR/$PACKAGE_NAME/" || true
        [ -f LICENSE ] && cp LICENSE "$INSTALL_DIR/$PACKAGE_NAME/" || true
        
        # Create symlink in /usr/local/bin
        echo "Creating symlink in /usr/local/bin..."
        ln -sf "$INSTALL_DIR/$PACKAGE_NAME/kcat" /usr/local/bin/kcat
        
        # Verify installation
        if [ -x "/usr/local/bin/kcat" ]; then
          echo ""
          echo "Installation successful!"
          echo ""
          echo "Installed version:"
          /usr/local/bin/kcat -V
          echo ""
          echo "You can now run 'kcat' from anywhere."
          echo "Try: kcat -h"
          echo ""
          echo "Installation location: $INSTALL_DIR/$PACKAGE_NAME"
        else
          echo "Installation failed"
          exit 1
        fi
        EOF
        
        chmod +x release/install.sh
        
        # Create uninstall script
        cat > release/uninstall.sh << 'EOF'
        #!/bin/bash
        set -e
        
        INSTALL_DIR="/usr/local"
        PACKAGE_NAME="kcat"
        
        if [ "$EUID" -ne 0 ]; then
          echo "Error: This script must be run as root or with sudo"
          exit 1
        fi
        
        echo "Uninstalling kcat..."
        
        # Remove symlink
        if [ -L "/usr/local/bin/kcat" ]; then
          rm -f /usr/local/bin/kcat
          echo "  Removed symlink: /usr/local/bin/kcat"
        fi
        
        # Remove installation directory
        if [ -d "$INSTALL_DIR/$PACKAGE_NAME" ]; then
          rm -rf "$INSTALL_DIR/$PACKAGE_NAME"
          echo "  Removed directory: $INSTALL_DIR/$PACKAGE_NAME"
        fi
        
        echo "kcat has been uninstalled"
        EOF
        
        chmod +x release/uninstall.sh
        
        # Create README
        cat > release/README_INSTALL.txt << 'EOF'
        kcat - CentOS 7 Binary Package
        ===============================
        
        This package contains kcat built on CentOS 7 with GLIBC 2.17 compatibility.
        
        Files:
        ---------
        kcat            - Wrapper script
        bin/kcat        - Actual binary file
        install.sh      - Installation script (installs to /usr/local)
        uninstall.sh    - Uninstallation script
        VERSION.txt     - Version and build information
        README.md       - Full documentation
        LICENSE         - License
        
        Usage:
        ---------
        
        Method 1: Direct run (recommended, no installation needed)
        $ ./kcat -V
        $ ./kcat -b broker:9092 -L
        
        Method 2: Install to system
        $ sudo ./install.sh
        $ kcat -V
        
        Uninstall:
        $ sudo ./uninstall.sh
        
        Common commands:
        -------------
        # Check version
        ./kcat -V
        
        # List cluster metadata
        ./kcat -b broker:9092 -L
        
        # Consume messages
        ./kcat -b broker:9092 -t my-topic -C
        
        # Produce messages
        echo "hello world" | ./kcat -b broker:9092 -t my-topic -P
        
        # Show help
        ./kcat -h
        
        System Requirements:
        -------------------
        - CentOS 7 / RHEL 7 or compatible (x86_64)
        - GLIBC 2.17 or later (CentOS 7 default)
        - Standard system libraries
        
        For more information see README.md or visit:
        https://github.com/edenhill/kcat
        EOF
        
        # Create the tarball
        cd release
        TARBALL_NAME="kcat-centos7-${GITHUB_SHA:0:8}.tar.gz"
        tar -czf "../$TARBALL_NAME" .
        cd ..
        
        # Display package info
        echo ""
        echo "=========================================="
        echo "Package created successfully!"
        echo "=========================================="
        ls -lh "$TARBALL_NAME"
        echo ""
        echo "Package contents:"
        tar -tzf "$TARBALL_NAME" | head -20
        echo ""
        echo "Total files: $(tar -tzf "$TARBALL_NAME" | wc -l)"
        
        # Test the wrapper script
        echo ""
        echo "Testing wrapper script..."
        cd release
        ./kcat -V || echo "Wrapper test completed"
        cd ..
    
    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: kcat-centos7-package
        path: |
          kcat-centos7-*.tar.gz
        retention-days: 90
        compression-level: 6
    
    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: kcat-centos7-*.tar.gz
        body: |
          ## CentOS 7 Binary Release
          
          This release includes kcat built on CentOS 7 with GLIBC 2.17 compatibility.
          
          ### Download and Install
          ```bash
          # Download and extract
          tar -xzf kcat-centos7-*.tar.gz
          cd kcat-centos7
          
          # Method 1: Direct use (recommended)
          ./kcat -V
          ./kcat -b broker:9092 -L
          
          # Method 2: Install to system
          sudo ./install.sh
          ```
          
          ### Features
          - ✅ Built on CentOS 7 (GLIBC 2.17)
          - ✅ Compatible with CentOS 7 and later systems
          - ✅ Full functionality (JSON, Avro, Transactions)
          - ✅ No additional dependencies required
          
          ### System Requirements
          - CentOS 7 / RHEL 7 or compatible (x86_64)
          - GLIBC 2.17 or later (CentOS 7 default)
          - Linux kernel 3.10 or later
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
